# Toy Experiment æ‰‹æ“å¤§æ¨¡å‹  
## ç›®æ ‡  
- å®ç°å¤šå¤´æ³¨æ„åŠ›ï¼Œæœ´ç´ Encoderã€Decoderã€Transformer **from scratch**
- å®ç°Bertã€GPT2ã€Llama3.1 æ¨ç†/è®­ç»ƒ  
- ç¼–å†™LLMså¾®è°ƒ/è®­ç»ƒæ¡†æ¶  
- å®ç°åˆ†å¸ƒå¼è®­ç»ƒ/æ¨ç†ï¼Œ flash attention  
## TODO  
- ~~GPT2 æ¨ç†/è®­ç»ƒ/generate~~
- Llama3.1 æ¨ç†/è®­ç»ƒ
- LLMs è®­ç»ƒæ¡†æ¶  

## è®°å½•
### 1. GPT2æ¨ç†æ—¶çš„logits NaNé—®é¢˜
> å¸¦æœ‰paddingçš„å¥å­ä¸­æœ€åçš„logitså…¨ä¸ºNaN  

**åˆ†æ**ï¼šè®¾è®¡`multiheadattention`æ—¶åªè€ƒè™‘åˆ°å³paddingï¼Œè¿™æ ·ä¸ä¼šå‡ºç°åˆ†æ•°çŸ©é˜µæŸä¸€è¡Œéƒ½è¢«maskçš„æƒ…å†µï¼Œå¹¶ä¸”ä½¿ç”¨äº†`-torch.inf`ä½œä¸ºmasked fillã€‚è€Œgpt2éœ€è¦å·¦paddingï¼Œå†ç»“åˆæ³¨æ„åŠ›maskå°±ä¼šå‡ºç°æŸä¸€è¡Œåœ¨softmaxåéƒ½æ˜¯NaNï¼Œåœ¨åç»§çš„`decoder`æ¨¡å—ä¸­ç»§ç»­ç›¸ä¹˜å°±ä¼šå‡ºç°è¯¥æ ·æœ¬çš„æ‰€æœ‰hidden stateéƒ½æ˜¯NaNçš„æƒ…å†µ  
**è§£å†³**ï¼š~~ä½¿ç”¨maskå°†NaNè¡Œç½®ä¸ºå…¨0ï¼Œä½†æ˜¯å®ç°å’ŒHFä¸åŒï¼Œæœ€åçš„logitsä¼šå’ŒHFæœ‰æ‰€åå·®(ä½“ç°åœ¨paddingçš„éƒ¨åˆ†)ã€‚å¦‚æœæ˜¯å³paddingçš„è¯åˆ™ä¸éœ€è¦~~   å’ŒHFåšæ³•å¯¹é½ï¼Œä½¿ç”¨è¾ƒå°çš„è´Ÿæ•°`-1e5`æ›¿ä»£`-torch.inf`ï¼Œå¹¶ä¸”ä¸éœ€è¦å¢åŠ è¿›ä¸€æ­¥çš„maskï¼Œå¯¹å·¦å³paddingéƒ½é€‚ç”¨

### 2.æœªç»é¢„è®­ç»ƒçš„GPT2é‡å¤æœ€åä¸€ä¸ªå•è¯çš„ç°è±¡
åœ¨å¾—åˆ†çŸ©é˜µä¸­ï¼ŒæŸtokenè‡ªå·±çš„Qï¼ŒKç›¸ä¹˜å¾—åˆ†è‚¯å®šæ˜¯æœ€é«˜çš„ï¼Œæœªè®­ç»ƒæ—¶æ˜¾è‘—é«˜äºå…¶ä»–tokenï¼Œåœ¨softmaxä¸­ä¼˜åŠ¿è¿›ä¸€æ­¥è¢«æ”¾å¤§ï¼Œå› æ­¤å’ŒvçŸ©é˜µç›¸ä¹˜åå’ŒåŸæ¥çš„çŸ©é˜µå˜åŒ–ä¸å¤§ï¼ŒåŠ ä¸Šæ®‹å·®è¿æ¥æœºåˆ¶ï¼Œæ¯ä¸€å±‚çš„è¾“å‡ºéƒ½å’Œè¾“å…¥ç›¸ä¼¼ã€‚GPT2çš„`LM Head`å’Œembeddingå…±äº«æƒé‡ï¼Œè€Œ`last_hidden_state`å’Œembeddingé•¿å¾—å·®ä¸å¤šï¼Œå› æ­¤åšlinearæ—¶æ¯ä¸ªtokençš„é¢„æµ‹åˆ†å¸ƒæ›´å€¾å‘äºè‡ªå·±ï¼Œå°±å¯¼è‡´LLMé‡å¤æœ€åä¸€ä¸ªè¯çš„è¶‹åŠ¿ã€‚  

### 3.åŠ è½½HuggingFace GPT2æƒé‡çš„é—®é¢˜
HFçš„GPT2å®ç°ä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„`Linear`å±‚éƒ½æ˜¯ç”¨`nn.Covd1d`å®ç°çš„ï¼Œå› æ­¤è¦å…ˆå°†`nn.Covd1d`æƒé‡**è½¬ç½®åå†æ‹·è´**åˆ°`Linear.weight`ã€‚**ï¼ˆæ­¤å¤„å› ä¸ºå¤šå¤´æ³¨æ„åŠ›è¿æ¥çš„æŠ•å½±çŸ©é˜µæœªè½¬ç½®è€Œdebugäº†å¥½ä¹…ï¼Œä¸€åº¦æ€€ç–‘æ¨¡å‹å®ç°æœ‰é—®é¢˜ğŸ˜­ï¼‰**ã€‚å¯¹äºhidden_stateåœ¨éencoder-decoderæ¨¡å‹ä¸­è½¬åŒ–ä¸ºkqvï¼Œ**HFæ˜¯å°†ä¸‰ä¸ªæŠ•å½±çŸ©é˜µæ‹¼æ¥æˆ(d, 3*d)å³`nn.Covd1d`çš„æƒé‡ï¼Œè¿›è¡Œä¸€æ¬¡çŸ©é˜µä¹˜æ³•ä¸€æ¬¡æ€§å¾—åˆ°çš„**ï¼Œæ­¤å¤„è¦å¯¹åº”å¥½`Linear`çš„å®ç°ã€‚

### 4.Generationå¼‚å¸¸ç°è±¡
> è¾“å…¥: [[a, b, c, d], [pad, pad, a, b]]  
> è§£ç ç­–ç•¥: è´ªå©ªè§£ç ã€‚
> 
> - å·¦padding  
> GPT2å¯¹äºç¬¬ä¸€å¥è¯å’Œhfçš„ä¸€æ ·,ç¬¬äºŒå¥è¯ä¸æ–­é‡å¤è¾“å‡ºçš„ç¬¬ä¸€ä¸ªå•è¯   
> - å³padding  
> GPT2å¯¹äºç¬¬ä¸€å¥è¯å’Œhfçš„ä¸€æ ·,ç¬¬äºŒå¥è¯å‰åŠæ®µå’ŒHFçš„ä¸€æ ·ï¼Œä½†æ˜¯ååŠæ®µå°±å¼€å§‹å˜äº†  
> - attention maskå›ºå®šä¸ºå…¨æ˜¯1çš„tensor  
> å‘ç°æ— è®ºæ˜¯å·¦è¿˜æ˜¯å³paddingï¼Œä¸¤å¥è¯è¾“å‡ºå’Œhfçš„å®Œå…¨ä¸€æ ·ã€‚  
> - å¯¹é¢„æµ‹ç”Ÿæˆç¬¬ä¸€ä¸ªå•è¯çš„logitsè¿›è¡Œ.mean()çš„æ¯”è¾ƒ  
> ä»¥ä¸Šçš„å®éªŒé…ç½®æ¡ä»¶ä¸‹ç»“æœéƒ½åœ¨å‡åœ¨1e-5çš„æ•°é‡çº§  

**åˆ†æ**ï¼šè®¡ç®—`position_ids`æ—¶æ²¡æœ‰å°†pad tokenè€ƒè™‘åœ¨å†…ï¼Œå¯¹äºgenerate HFæœ‰prepare_input_for_generateæ–¹æ³•è¿›è¡Œé¢„å¤„ç†ï¼Œè€Œforwardåˆ™æ²¡æœ‰è¿™æ­¥ï¼Œç”¨arangeç”Ÿæˆ

